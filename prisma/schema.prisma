generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Ability {
  CREATE
  READ
  UPDATE
  DELETE
  ASSIGN
}

enum Action {
  CREATE
  DELETE
  GET_ONE
  GET_ALL
  LOGIN
  LOGOUT
  RESTORE
  UPDATE
}

enum Model {
  AUTH
}

enum Resource {
  BENEFICIARY
  INCIDENCE
  USER
  REPORT
}

enum Status {
  BLOCKED
  FAILED
  SUCCESS
}

model Access {
  id                            String                          @id @default(uuid())
  permission_id                 String
  role_id                       String
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  permission                    Permission                      @relation(fields: [permission_id], references: [id])
  role                          Role                            @relation(fields: [role_id], references: [id])
  @@unique([permission_id, role_id])
}

model Assignment {
  id                            String                          @id @default(uuid())
  module_id                     String?
  program_id                    String
  role_id                       String
  user_id                       String
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  module                        Module?                         @relation(fields: [module_id], references: [id])
  program                       Program                         @relation(fields: [program_id], references: [id])
  role                          Role                            @relation(fields: [role_id], references: [id])
  user                          User                            @relation(fields: [user_id], references: [id])
  @@unique([module_id, program_id, role_id, user_id])
}

model Audit {
  id                            String                          @id @default(uuid())
  description                   String
  register_id                   String?
  field                         String?
  preview_content               String?
  new_content                   String?
  user_id                       String?
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  action                        Action
  model                         Model
  status                        Status                          @default(SUCCESS)
  user                          User?                           @relation(fields: [user_id], references: [id])
  @@index([action])
  @@index([model])
  @@index([status])
  @@index([user_id])
}

model Permission {
  id                            String                          @id @default(uuid())
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  action                        Ability
  resource                      Resource
  accesses                      Access[]   
  @@unique([action, resource])      
}

model Program {
  id                            String                          @id @default(uuid())
  name                          String                          @unique
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  assignments                   Assignment[]
  modules                       Module[]
}

model Module {
  id                            String                          @id @default(uuid())
  name                          String                          @unique
  program_id                    String
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  program                       Program                         @relation(fields: [program_id], references: [id])
  assignments                   Assignment[]
  @@index([program_id])
  @@unique([name, program_id])
}

model Role {
  id                            String                          @id @default(uuid())
  name                          String                          @unique
  is_super                      Boolean                         @default(false)
  created_at                    DateTime                        @default(now())
  deleted_at                    DateTime?
  accesses                      Access[]  
  assignments                   Assignment[]
}

model User {
  id                            String                          @id @default(uuid())
  username                      String                          @unique
  password                      String
  name                          String
  lastname                      String
  email                         String                          @unique
  dni                           String?                         @unique
  phone                         String?                         @unique
  created_at                    DateTime                        @default(now())
  updated_at                    DateTime                        @updatedAt
  deleted_at                    DateTime?
  assignments                   Assignment[]
  audits                        Audit[]
}
